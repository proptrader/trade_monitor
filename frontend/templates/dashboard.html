<div class="container mx-auto px-4 py-8">
    <!-- Tab Navigation -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button id="live-trades-tab" class="border-primary text-primary whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Live Trades
            </button>
            <button id="all-trades-tab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                All Trades
            </button>
        </nav>
    </div>

    <!-- Live Trades Panel -->
    <div id="live-trades-panel">
        <!-- Trade Controls -->
        <div class="mb-6">
            <div class="flex space-x-4">
                <button id="replicate-btn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90" hx-post="http://localhost:5000/api/trades/replicate" hx-swap="outerHTML">
                    Replicate Trades
                </button>
                <button id="stop-btn" class="bg-error text-white px-4 py-2 rounded-md hover:bg-error/90 hidden" hx-post="http://localhost:5000/api/trades/stop" hx-swap="outerHTML">
                    Stop Replicating
                </button>
            </div>
        </div>

        <!-- Trade Table -->
        <div class="bg-white shadow-sm rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Live Trades</h2>
                    <div class="flex space-x-4">
                        <select id="tag-select" class="rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option value="">Select Tag</option>
                        </select>
                        <button id="live-export-btn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90" style="background-color: #1a56db; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                            Export to Google Sheets
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary" hx-on:change="toggleAllTrades(this)">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body" class="bg-white divide-y divide-gray-200" hx-get="http://localhost:5000/api/trades/stream" hx-trigger="load" hx-swap="beforeend">
                            <!-- Trades will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- All Trades Panel -->
    <div id="all-trades-panel" class="hidden">
        <!-- Account Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" id="account-tabs" aria-label="Account Tabs">
                <!-- Account tabs will be loaded here -->
            </nav>
        </div>

        <!-- Trade List -->
        <div class="bg-white shadow-sm rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">All Trades</h2>
                    <div class="flex space-x-4">
                        <div class="relative">
                            <input type="text" id="tag-input" class="rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Enter tag...">
                            <div id="recent-tags" class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md hidden">
                                <!-- Recent tags will be loaded here -->
                            </div>
                        </div>
                        <button id="all-export-btn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90" style="background-color: #1a56db; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                            Export to Google Sheets
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" class="rounded border-gray-300 text-primary focus:ring-primary" hx-on:change="toggleAllTrades(this)">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="all-trades-body" class="bg-white divide-y divide-gray-200">
                            <!-- Trades will be loaded here -->
                        </tbody>
                    </table>
                    <div id="loading-indicator" class="hidden text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add inline styles to ensure export buttons are always clickable -->
<style>
    /* Force buttons to be clickable regardless of CSS issues */
    #live-export-btn, #all-export-btn {
        pointer-events: auto !important;
        cursor: pointer !important;
        opacity: 1 !important;
    }
    
    /* Make sure primary color shows even if Tailwind classes don't work */
    .bg-primary-fallback {
        background-color: #1a56db !important;
    }
    
    .text-white-fallback {
        color: white !important;
    }
    
    /* Style the alternative form buttons */
    .alt-export-form {
        display: inline-block;
        margin: 0;
        padding: 0;
    }
    
    .alt-export-btn {
        background-color: #1a56db !important;
        color: white !important;
        padding: 0.5rem 1rem !important;
        border-radius: 0.375rem !important;
        border: none !important;
        cursor: pointer !important;
        font-size: 0.875rem !important;
        font-weight: 500 !important;
    }
    
    /* Hide form fields */
    .hidden-field {
        display: none !important;
    }
</style>

<script>
    // Define showToast if it doesn't exist (for when loaded as a partial)
    if (typeof showToast !== 'function') {
        function showToast(message, type = 'info') {
            if (window.showToast) {
                // Use global showToast if available
                window.showToast(message, type);
                return;
            }
            
            let toast = document.getElementById('toast');
            let toastMessage = document.getElementById('toast-message');
            
            if (!toast) {
                // Create toast element if it doesn't exist
                const toastDiv = document.createElement('div');
                toastDiv.id = 'toast';
                toastDiv.className = 'fixed bottom-4 right-4 hidden';
                toastDiv.style.position = 'fixed';
                toastDiv.style.bottom = '1rem';
                toastDiv.style.right = '1rem';
                toastDiv.style.zIndex = '9999';
                
                const innerDiv = document.createElement('div');
                innerDiv.className = 'bg-white rounded-lg shadow-lg p-4';
                innerDiv.style.backgroundColor = 'white';
                innerDiv.style.borderRadius = '0.5rem';
                innerDiv.style.padding = '1rem';
                innerDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                
                const paragraph = document.createElement('p');
                paragraph.id = 'toast-message';
                
                innerDiv.appendChild(paragraph);
                toastDiv.appendChild(innerDiv);
                document.body.appendChild(toastDiv);
                
                toastMessage = paragraph;
                toast = toastDiv;
            }
            
            toastMessage.textContent = message;
            
            // Set text color based on type
            if (type === 'error') {
                toastMessage.style.color = '#dc2626';
            } else if (type === 'success') {
                toastMessage.style.color = '#059669';
            } else if (type === 'warning') {
                toastMessage.style.color = '#d97706';
            } else {
                toastMessage.style.color = '#1f2937';
            }
            
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    }

    // Tab switching
    document.getElementById('live-trades-tab').addEventListener('click', () => {
        document.getElementById('live-trades-panel').classList.remove('hidden');
        document.getElementById('all-trades-panel').classList.add('hidden');
        document.getElementById('live-trades-tab').classList.add('border-primary', 'text-primary');
        document.getElementById('live-trades-tab').classList.remove('border-transparent', 'text-gray-500');
        document.getElementById('all-trades-tab').classList.add('border-transparent', 'text-gray-500');
        document.getElementById('all-trades-tab').classList.remove('border-primary', 'text-primary');
    });

    document.getElementById('all-trades-tab').addEventListener('click', () => {
        document.getElementById('live-trades-panel').classList.add('hidden');
        document.getElementById('all-trades-panel').classList.remove('hidden');
        document.getElementById('all-trades-tab').classList.add('border-primary', 'text-primary');
        document.getElementById('all-trades-tab').classList.remove('border-transparent', 'text-gray-500');
        document.getElementById('live-trades-tab').classList.add('border-transparent', 'text-gray-500');
        document.getElementById('live-trades-tab').classList.remove('border-primary', 'text-primary');
        loadAccountTabs();
    });

    // Load account tabs
    function loadAccountTabs() {
        fetch('http://localhost:5000/api/accounts')
            .then(response => response.json())
            .then(accounts => {
                const tabsContainer = document.getElementById('account-tabs');
                tabsContainer.innerHTML = '';
                accounts.forEach(account => {
                    const tab = document.createElement('button');
                    tab.className = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
                    tab.textContent = account.account_id;
                    tab.onclick = () => loadTrades(account.account_id);
                    tabsContainer.appendChild(tab);
                });
                if (accounts.length > 0) {
                    loadTrades(accounts[0].account_id);
                }
            });
    }

    // Load trades with infinite scroll
    let currentPage = 1;
    let currentAccountId = null;
    let isLoading = false;
    let hasMore = true;

    function loadTrades(accountId) {
        currentAccountId = accountId;
        currentPage = 1;
        hasMore = true;
        document.getElementById('all-trades-body').innerHTML = '';
        loadMoreTrades();
    }

    function loadMoreTrades() {
        if (isLoading || !hasMore) return;
        isLoading = true;
        document.getElementById('loading-indicator').classList.remove('hidden');

        fetch(`http://localhost:5000/api/trades/history?account_id=${currentAccountId}&page=${currentPage}&limit=50`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('all-trades-body');
                data.trades.forEach(trade => {
                    const row = createTradeRow(trade);
                    tbody.appendChild(row);
                });
                hasMore = data.has_more;
                currentPage++;
                isLoading = false;
                document.getElementById('loading-indicator').classList.add('hidden');
            });
    }

    // Infinite scroll observer
    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
            loadMoreTrades();
        }
    });

    observer.observe(document.getElementById('loading-indicator'));

    // Create trade row
    function createTradeRow(trade) {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="checkbox" name="trade" value="${trade.trade_id}" class="rounded border-gray-300 text-primary focus:ring-primary">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.trade_id}</td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.account_id}</td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.symbol}</td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.price}</td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.order_type}</td>
            <td class="px-6 py-4 whitespace-nowrap">${trade.product_type}</td>
            <td class="px-6 py-4 whitespace-nowrap">${new Date(trade.timestamp).toLocaleString()}</td>
        `;
        return row;
    }

    // Load tags
    fetch('http://localhost:5000/api/trades/tags')
        .then(response => response.json())
        .then(tags => {
            const select = document.getElementById('tag-select');
            const recentTags = document.getElementById('recent-tags');
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                select.appendChild(option);

                const tagElement = document.createElement('div');
                tagElement.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                tagElement.textContent = tag;
                tagElement.onclick = () => {
                    document.getElementById('tag-input').value = tag;
                    recentTags.classList.add('hidden');
                };
                recentTags.appendChild(tagElement);
            });
        });

    // Show/hide recent tags
    document.getElementById('tag-input').addEventListener('focus', () => {
        document.getElementById('recent-tags').classList.remove('hidden');
    });

    document.getElementById('tag-input').addEventListener('blur', () => {
        setTimeout(() => {
            document.getElementById('recent-tags').classList.add('hidden');
        }, 200);
    });

    // Toggle all trades
    function toggleAllTrades(checkbox) {
        const container = checkbox.closest('table').querySelector('tbody');
        const checkboxes = container.querySelectorAll('input[type="checkbox"][name="trade"]');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        updateExportButtonState();
    }

    // Handle trade replication
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.pathInfo.requestPath === 'http://localhost:5000/api/trades/replicate') {
            document.getElementById('replicate-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            showToast('Trade replication started', 'success');
        } else if (evt.detail.pathInfo.requestPath === 'http://localhost:5000/api/trades/stop') {
            document.getElementById('replicate-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            showToast('Trade replication stopped', 'info');
        }
    });

    // Update export button state based on selection
    function updateExportButtonState() {
        // Get all selected trades
        const liveTrades = Array.from(document.querySelectorAll('#trades-body input[name="trade"]:checked'));
        const allTrades = Array.from(document.querySelectorAll('#all-trades-body input[name="trade"]:checked'));
        
        // Update live export button
        const liveExportBtn = document.getElementById('live-export-btn');
        if (liveExportBtn) {
            if (liveTrades.length > 0) {
                liveExportBtn.removeAttribute('disabled');
                liveExportBtn.style.opacity = '1';
                liveExportBtn.style.cursor = 'pointer';
            } else {
                liveExportBtn.setAttribute('disabled', 'disabled');
                liveExportBtn.style.opacity = '0.5';
                liveExportBtn.style.cursor = 'not-allowed';
            }
        }
        
        // Update all export button
        const allExportBtn = document.getElementById('all-export-btn');
        if (allExportBtn) {
            if (allTrades.length > 0) {
                allExportBtn.removeAttribute('disabled');
                allExportBtn.style.opacity = '1';
                allExportBtn.style.cursor = 'pointer';
            } else {
                allExportBtn.setAttribute('disabled', 'disabled');
                allExportBtn.style.opacity = '0.5';
                allExportBtn.style.cursor = 'not-allowed';
            }
        }
    }

    // Initialize export functionality
    function initializeExport() {
        // Find the export buttons
        const liveExportBtn = document.getElementById('live-export-btn');
        const allExportBtn = document.getElementById('all-export-btn');
        
        // Ensure button has inline styles
        if (liveExportBtn) {
            liveExportBtn.style.backgroundColor = '#1a56db';
            liveExportBtn.style.color = 'white';
            liveExportBtn.style.padding = '0.5rem 1rem';
            liveExportBtn.style.borderRadius = '0.375rem';
            liveExportBtn.style.cursor = 'pointer';
        }
        
        if (allExportBtn) {
            allExportBtn.style.backgroundColor = '#1a56db';
            allExportBtn.style.color = 'white';
            allExportBtn.style.padding = '0.5rem 1rem';
            allExportBtn.style.borderRadius = '0.375rem';
            allExportBtn.style.cursor = 'pointer';
        }
        
        // Add button event listeners        
        if (liveExportBtn) {
            liveExportBtn.addEventListener('click', handleLiveExport);
        }
        
        if (allExportBtn) {
            allExportBtn.addEventListener('click', handleAllExport);
        }
        
        // Initialize export button states
        updateExportButtonState();
    }
    
    // Handle Live Export
    function handleLiveExport(e) {
        e.preventDefault();
        
        try {
            const selectedTrades = Array.from(document.querySelectorAll('#trades-body input[name="trade"]:checked')).map(cb => cb.value);
            const tag = document.getElementById('tag-select')?.value || '';
            
            if (selectedTrades.length === 0) {
                showToast('Please select at least one trade to export', 'error');
                return;
            }
            
            if (!tag) {
                showToast('Please select a tag for the export', 'error');
                return;
            }
            
            // Make the fetch request
            fetch('http://localhost:5000/api/trades/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trades: selectedTrades, tag: tag })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) showToast(data.message, 'success');
                else if (data.error) showToast(data.error, 'error');
            })
            .catch(err => {
                showToast('Export failed: ' + err.message, 'error');
            });
        } catch (err) {
            showToast('Export processing error: ' + err.message, 'error');
        }
    }
    
    // Handle All Export
    function handleAllExport(e) {
        e.preventDefault();
        
        try {
            const selectedTrades = Array.from(document.querySelectorAll('#all-trades-body input[name="trade"]:checked')).map(cb => cb.value);
            const tag = document.getElementById('tag-input')?.value || '';
            
            if (selectedTrades.length === 0) {
                showToast('Please select at least one trade to export', 'error');
                return;
            }
            
            if (!tag) {
                showToast('Please enter a tag for the export', 'error');
                return;
            }
            
            if (!currentAccountId) {
                showToast('No account ID available. Please select an account.', 'error');
                return;
            }
            
            // Make the fetch request
            fetch('http://localhost:5000/api/trades/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trades: selectedTrades, tag: tag, account_id: currentAccountId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) showToast(data.message, 'success');
                else if (data.error) showToast(data.error, 'error');
            })
            .catch(err => {
                showToast('Export failed: ' + err.message, 'error');
            });
        } catch (err) {
            showToast('Export processing error: ' + err.message, 'error');
        }
    }
    
    // Initialize export on DOM load or when Tailwind is ready
    if (typeof window.runWhenTailwindReady === 'function') {
        window.runWhenTailwindReady(initializeExport);
    } else {
        document.addEventListener('DOMContentLoaded', initializeExport);
    }
    
    // Listen for the components:initialize event
    document.addEventListener('components:initialize', function() {
        initializeExport();
    });
    
    // Listen for changes in checkboxes using event delegation
    document.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && e.target.name === 'trade') {
            updateExportButtonState();
        }
    });

    // Add a mutation observer to watch for new trades being added to the DOM
    const tradeBodyObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // New nodes were added, check if they have checkboxes
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        const checkboxes = node.querySelectorAll('input[type="checkbox"][name="trade"]');
                        if (checkboxes.length > 0) {
                            // New trades with checkboxes were added
                            updateExportButtonState();
                        }
                    }
                });
            }
        });
    });

    // Start observing both trade bodies
    document.addEventListener('DOMContentLoaded', function() {
        const liveTradesBody = document.getElementById('trades-body');
        const allTradesBody = document.getElementById('all-trades-body');
        
        if (liveTradesBody) {
            tradeBodyObserver.observe(liveTradesBody, { childList: true, subtree: true });
        }
        
        if (allTradesBody) {
            tradeBodyObserver.observe(allTradesBody, { childList: true, subtree: true });
        }
    });
</script> 